# Docker最佳实践之镜像构建

说最佳实践显然有点标题党，不过这确实是这些日子实践以来的总结，准备从几个主题进行总结：

1. 镜像构建 
2. Dockerfile 
3. Docker-compose
4. 镜像及容器的使用运维


这算是开篇吧。下面进入正题：

- 使用Dockerfile来构建镜像

Docker镜像构建的方式不止Dockerfile，不过显然，大多数情况下，这都是最佳的。因为出了问题，可以随时根据dockerfile进行重建，而且还可以把文件托管到Github上面，实现自动构建。不过这同时也会出现一些新的状况，例如不同的项目可能有不同的依赖，如果不同的项目使用不同的dockerfile进行构建，可能就会产生的管理问题；而如果使用统一的镜像，又可能变成大而全，镜像的size就可能变得很大。而且开发和制作镜像的通常不是同一个团队。

- 基于官方的基础镜像进行构建 

Docker官方提供了很多的基础镜像，基于这些镜像的基础上进行构建可以省略很多不必要的麻烦。当然也有完美主义者希望构建尽可能小的镜像，如[文章](http://segmentfault.com/a/1190000000628247  )，有时间的话可以慢慢折腾，不过我觉得够用最好，况且最小的镜像可能会有潜在的问题（至少增加了维护的复杂性吧）。

- 官方镜像中选择尽可能小的作为基础镜像

例如ruby的镜像就有三种类型`ruby:<version>`，`ruby:onbuild`，`ruby:slim`，即使对于同一个版本，这三者之间的差距也是相当的大，我们选择基于slim镜像进行构建。构建的时候可能会出现一些依赖问题，不过这应该都是可以解决的。

- 不要在镜像中加入git，vim等开发工具

在镜像中vim文件，git clone等操作会造成各种权限问题，而且需要支持中文也是一个比较大的问题。即使把这些封装到一个单独的镜像也不建议。如果想开发同事的开发环境基本一致，可以通过脚本来部署本地开发环境。（当然这个隔离性没有镜像方便，也许将来也会适合在镜像中编辑文件吧）

- 不同版本的环境构建成不同的镜像

例如Python2.7，Python3.5，不需要在同一个镜像里部署多个版本的环境，将镜像变得复杂。

- 镜像尽量单一服务，而不是基于项目

比较明显的，例如php-fpm，可以每个项目建一个镜像，这样虽然更加容易部署，但是这样镜像会变得很多很难管理。

- 构建自己的镜像体系

从官方的基础镜像继承，首先构建我们自己的*基础镜像*，然后构建具体业务镜像，在本地开发环境再构建对应的开发镜像。自己的体系可以有一个命名规范，保证整体的统一性。基础镜像可以实现一些基础的东西，例如修改时区，引入国内的apt源（例如阿里云），定义工作目录等

- 注意区分开发环境的镜像和生产环境的镜像 

首先构建生产环境的镜像，然后基于生产环境的镜像构建开发镜像，可以加入相应的测试工具构建构建等。

- 使用纯数据镜像 

如果在每个镜像都独自挂载公共目录（如代码目录，数据目录或者日志目录等），那样管理起来就比较麻烦，不如直接启动一个纯数据镜像，在这个镜像里面定义好公共目录，挂载外部目录，然后在其他的目录只要link这个镜像即可。



