# Flask-Migrate：数据库迁移脚本使用

Flask Migrate 的核心思想是：开发只需要定义数据对象，通过命令自动生成迁移脚本，完成数据库结构的变更。

## 0. 环境安装

```sh
python3 -m pip install Flask-Migrate
python3 -m pip install Flask-Script
```

帮助命令：

```
Options:
  --help  Show this message and exit.

Commands:
  branches   Show current branch points
  current    Display the current revision for each...
  downgrade  Revert to a previous version
  edit       Edit a revision file
  heads      Show current available heads in the script...
  history    List changeset scripts in chronological...
  init       Creates a new migration repository.
  merge      Merge two revisions together, creating a new...
  migrate    Autogenerate a new revision file (Alias for...
  revision   Create a new revision file.
  show       Show the revision denoted by the given...
  stamp      'stamp' the revision table with the given...
  upgrade    Upgrade to a later version
```

## 1. 数据库定义脚本

vim app.py

```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_script import Manager
from flask_migrate import Migrate, MigrateCommand

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
migrate = Migrate(app, db)

manager = Manager(app)
manager.add_command('db', MigrateCommand)


class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128))

if __name__ == '__main__':
    manager.run()
```

## 2. 初始化

```
flask db init
  Creating directory /var/www/tmp/migrate/migrations ... done
  Creating directory /var/www/tmp/migrate/migrations/versions ... done
  Generating /var/www/tmp/migrate/migrations/env.py ... done
  Generating /var/www/tmp/migrate/migrations/alembic.ini ... done
  Generating /var/www/tmp/migrate/migrations/script.py.mako ... done
  Generating /var/www/tmp/migrate/migrations/README ... done
  Please edit configuration/connection/logging settings in
  '/var/www/tmp/migrate/migrations/alembic.ini' before proceeding.
```

初始化之后，会在目录下生成`migrations`目录，其内容如下：

```
alembic.ini  env.py  README  script.py.mako  versions
```

## 3. 创建迁移脚本

```
flask db migrate    
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'user'
  Generating /var/www/tmp/migrate/migrations/versions/a6b6550cdd26_.py ... done
```

这时就生成了一个迁移脚本`migrations/versions/a6b6550cdd26_.py`

注意：创建迁移脚本时，更好的写法应该是：`flask db migrate -m 'add user'`，这时生成的文件应该是`migrations/versions/a6b6550cdd26_add_user.py`

其主要内容如下：

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('user',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=128), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('user')
    # ### end Alembic commands ###
```


## 4. 将迁移中的改动应用到数据库

```
flask db upgrade
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> a6b6550cdd26, empty message
```

## 5. 继续修改数据库定义脚本

vim app.py
例如给User增加一个age字段，如下：

```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128))
    age = db.Column(db.Integer)
```

## 6. 生成新的迁移脚本

```
flask db migrate -m 'add age to user'
```

这时会自动创建迁移脚本`migrations/versions/a530ea206fc0_add_age_to_user.py`，其核心代码如下：

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('user', sa.Column('age', sa.String(length=12), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('user', 'age')
    # ### end Alembic commands ###
```

migration会自动User的差异，自动创建变更代码。

注意：`并不是所有变化都能自动生成`，具体见：https://alembic.zzzcomputing.com/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect

## 7. 重新更新到数据库

```
flask db upgrade
```

## 8. 手动创建迁移文件

当自动生成迁移文件失效的时候，例如改变某个字段的类型，需要手动进行创建：

```
flask db revision -m 'change age to int'
```


