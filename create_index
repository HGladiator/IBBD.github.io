#!/bin/bash
# 
# 生成index文件列表
# 

# 索引文件
index_filename='0-index.md'
index_date_filename='0-index-date.md'

# 字典配置
declare -A dict
dict[database]=数据库
dict[front-end]=前端
#dict[]=

############## 按目录排序 ######################

url_prefix=https://github.com/IBBD/blog/tree/master/
output_index() {
    sortby=$1
    if [ 'date' ]; then 
        echo "[按目录索引]($url_prefix$index_filename )  |  按日期索引"
    else 
        echo "按目录索引  |  [按日期索引]($url_prefix$index_date_filename )"
    fi
}

files=$(find ./[0-9a-z_]*)
echo '## 文章目录 - 按目录索引' > $index_filename
echo >> $index_filename
output_index >> $index_filename
echo >> $index_filename

for p in $files
do
    f=${p##*/}
    num=$(echo $p | awk -F'/' '{print NF-1}')
    num=$[($num-1)*2+1]
    spaces=$(seq -s' ' $num | tr -d '[0-9]')
    echo $num:"$spaces"$p
    if [ -d $p ]
    then
        # 输出目录
        if [ ${dict[$f]} ]
        then
            title=${dict[$f]}
        else
            title=$f
        fi
        #echo "$spaces- [$title]($url_prefix${p:2})" >> $index_filename
        echo "$spaces- $title" >> $index_filename
    elif [ -f $p -a 'md' = ${f##*.} -a 'README' != ${f%.*} -a $index_filename != ${p:2} -a $index_date_filename != ${p:2} ] 
    then
        # 输出文件
        title=$(head -n 1 $p|sed 's/^#*\s*//'|sed 's/\s*$//')
        [ ${#title} -lt 2 ] && title=${p%.*}
        echo "$spaces- [$title]($url_prefix${p:2})" >> $index_filename
    fi
done

echo '============= END OF 按目录索引 ================'
echo 
echo 

############## 按日期排序 ######################

echo '## 文章目录 - 按日期索引' > $index_date_filename
echo >> $index_date_filename
output_index 'date' >> $index_date_filename
echo >> $index_date_filename

file_date_last=
files=$(find ./ -name "*.md" | xargs ls -t)
for p in $files
do
    f=${p##*/}
    if [ '0-index' != ${f:0:7} -a 'README.md' != $f ]; then 
        file_date=$(ls $p --full-time|awk -F' ' '{print $6}')
        if [ "$file_date_last" != "$file_date" ]; then 
            echo >> $index_date_filename
            echo "#### \033[40;33m"$file_date"\033[0m" | tee -a $index_date_filename
            echo >> $index_date_filename
            file_date_last=$file_date
        fi

        # 输出文件
        title=$(head -n 1 $p|sed 's/^#*\s*//'|sed 's/\s*$//')
        [ ${#title} -lt 2 ] && title=${p%.*}
        echo "- [$title]($url_prefix${p:2})" | tee -a $index_date_filename
    fi
done

echo '============= END OF 按日期索引 ================'

echo '====> finish!'
