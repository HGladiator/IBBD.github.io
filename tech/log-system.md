# 大型系统的日志系统架构思考

    因为最近经常在处理日志相关的任务，稍做总结。

日志虽然通常与业务无关，但是作为一个大型系统，日志系统必然是其中最主要的模块之一。日志系统的完善程度通常可以用来衡量一个系统的健壮性，可测试性，可维护性等。

对于日志系统架构，设计上最最主要的一条原则是：`随时提醒自己，如果系统出问题了，甚至异常中止了，怎么办`，根据墨菲定律，所有可能发生的事，都会发生，这个用在高并发的大型系统上，绝对适合。

## 日志系统用来做什么

日志系统的目标通常有几个：

- 出问题的时候，能根据日志快速定位问题
- 出问题的时候，能根据日志进行回滚或者重做
- 根据日志对系统进行优化

## 日志系统的重点需要考虑的点

- 关键日志：关键操作必须要有日志，例如涉及到金额的结算，无论结算是否成功都应该有日志，如果失败的话，还应该记录失败的原因
- 不能影响程序的执行效率：非业务类日志如果写入太频繁，很容易造成系统IO过大的问题，例如nginx的access log，在生产环境通常是关闭的，在需要的时候才打开
- 配置性：能够方便的控制各种日志的输出，包括观测运行时间，异常日志，内存数据等，而不是需要修改代码，重新编译等
- 自动降级：日志很多时候都是重要的，但是当服务器压力很大的时候，应该能自动减少非关键日志的输出。例如一些非关键日志，在平常时候可能以1%的概率进行输出，但是当压力上来之后，应该自动调整成万分之一，甚至更低。

## 通常的日志类型

- 业务日志：例如结算日志，这是跟业务相关的日志，这些日志通常都是比较重要的。回滚和重做都依赖于这部分日志
- 异常日志：程序运行过程中产生的各种异常的日志，这些日志通常有等级的区分，通常的分级例如：debug, info, warn, error, fatal等，生产环境正常应该都是只输出error和fatal级别，应该提供可能通过配置的方式来控制输出其他等级的日志
- 运行效率日志：例如整个系统分成了若干个前后相连的模块，那么在正常环境中每个模块的执行效率怎么样，瓶颈在哪里，这些应该能通过日志观察到。最大值和平均值，这是最简单的衡量指标。这些日志不是必须的，系统需要降级时，可以优先降级。
- 慢响应日志：这个概率借鉴数据库的慢查询日志。应该有一个响应时间的阀值，当超过这个阀值的时候，应该有相应的日志。同样，这部分日志要重点关注其对系统整体性能的影响。
- Debug日志：这通常是容易被忽略的部分，对于一个大型系统，例如广告平台，如果某个广告投放不出去怎么办，或者某个用户接收不到广告怎么办，查日志当然可以解决部分问题，但是这时前面部分的日志通常帮不上太多忙，因为生产环境上，能用上的通常是异常日志，但是绝大多数时候都不会触发异常日志的，因为这样的话日志太多了，可能会严重影响性能。这时应该有一个机制，能通过相应的配置，就能观察到相应的原因，而且这个步骤应该不需要技术的介入。甚至如果足够智能的话，能够自动在后台展示出来。

## 日志的功能点

- 可以设置等级，并按等级输出日志
- 日志应该支持异步写入，减少随机IO
- 日志应该能支持按概率写入，例如1%的概率写日志
- 能支持按照时间写入，例如每秒最多只写入一条记录。记录运行时间的日志最适合这种
- 能支持自动降级

---------

待续.....

